<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ศูนย์อัปโหลด/ดาวน์โหลดแอพ (รองรับ 1GB)</title>
  <style>
    :root { --bg:#0f1220; --panel:#171a2b; --text:#e5e7ef; --muted:#a9afc7;
      --primary:#6ea0ff; --primary-hover:#85afff; --danger:#ff6e6e; --success:#59d37d;
      --warning:#f5c04e; --border:#2a314a; --gray:#3a415f; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:"Segoe UI",system-ui,-apple-system,sans-serif}
    header{position:sticky;top:0;z-index:10;background:rgba(23,26,43,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .nav{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .nav h1{font-size:18px;margin:0}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer;transition:.2s;user-select:none}
    .btn:hover{background:#1e2237}
    .btn-primary{background:var(--primary);color:#0b1020;border-color:transparent}
    .btn-primary:hover{background:var(--primary-hover)}
    .btn-ghost{background:transparent}
    .btn-danger{background:var(--danger);color:#0b1020;border-color:transparent}
    .btn-success{background:var(--success);color:#0b1020;border-color:transparent}
    .btn[disabled],.btn.disabled{cursor:not-allowed;opacity:.6;background:var(--gray);color:#cfd5ee}
    main{max-width:1100px;margin:0 auto;padding:20px 16px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media (max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:8px}
    .field label{font-size:14px;color:var(--muted)}
    .input,textarea,select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:#121527;color:var(--text)}
    textarea{min-height:100px;resize:vertical}
    .hint{font-size:12px;color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .avatar{width:92px;height:92px;border-radius:12px;background:#0c0f1e;border:1px dashed var(--gray);display:grid;place-items:center;color:var(--muted);overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .list{display:grid;grid-template-columns:1fr;gap:12px}
    .item{display:grid;grid-template-columns:96px 1fr;gap:12px;padding:12px;border-radius:12px;border:1px solid var(--border);background:#14172a}
    .item .cover{width:96px;height:96px;border-radius:12px;background:#0c0f1e;border:1px dashed var(--gray);overflow:hidden}
    .item .cover img{width:100%;height:100%;object-fit:cover}
    .item h3{margin:0;font-size:16px}
    .meta{font-size:13px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 10px;border-radius:20px;border:1px solid var(--border);color:#c9cfee;background:#101327}
    .searchbar{display:grid;grid-template-columns:2fr 1fr auto;gap:10px}
    @media (max-width:700px){.searchbar{grid-template-columns:1fr}}
    .detail{display:grid;grid-template-columns:160px 1fr;gap:16px}
    @media (max-width:700px){.detail{grid-template-columns:1fr}}
    .divider{border-top:1px solid var(--border);margin:12px 0}
    .note{font-size:12px;color:var(--muted)}
    footer{padding:24px 16px;color:var(--muted);text-align:center}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .stack{display:flex;flex-direction:column;gap:8px}
    .progress-wrap{display:flex;flex-direction:column;gap:6px}
    .progress-bar{height:10px;background:#0c0f1e;border:1px solid var(--border);border-radius:8px;overflow:hidden}
    .progress-bar > div{height:100%;background:var(--success);width:0%}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;color:#cfd5ee}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <h1>ศูนย์แอพชุมชน (อัปโหลดถึง 1GB)</h1>
      <div class="spacer"></div>
      <button type="button" class="btn btn-ghost" data-nav="list">รายการดาวน์โหลด</button>
      <button type="button" class="btn btn-primary" data-nav="upload">อัปโหลดแอพ/โปรแกรม</button>
    </div>
  </header>

  <main>
    <section id="home" class="panel">
      <div class="grid-2">
        <div class="stack">
          <h2 style="margin:0">เริ่มต้น</h2>
          <p>โค้ดนี้รองรับอัปโหลดไฟล์ใหญ่ถึง 1GB ด้วยการอัปโหลดแบบแบ่งชิ้นไปยังเซิร์ฟเวอร์จริง พร้อมบันทึกเมตาดาต้าใน localStorage และปุ่มดาวน์โหลดอัจฉริยะตามอุปกรณ์ (PC/มือถือ)</p>
          <div class="row">
            <button type="button" class="btn btn-primary" data-nav="upload">เลือกอัปโหลด</button>
            <button type="button" class="btn" data-nav="list">ไปหน้ารายการดาวน์โหลด</button>
          </div>
          <p class="note">ต้องมี API ฝั่งเซิร์ฟเวอร์สำหรับ /upload/init, /upload/chunk, /upload/complete เพื่อใช้งานอัปโหลด 1GB ได้จริง</p>
        </div>
        <div class="stack">
          <div class="badge">อุปกรณ์ของคุณ: <span id="deviceLabel">ตรวจสอบ...</span></div>
          <div class="badge">จำนวนแอพในระบบ: <span id="countLabel">0</span></div>
          <div class="badge">โหมดบันทึก: localStorage (เฉพาะเมตาดาต้า)</div>
        </div>
      </div>
    </section>

    <section id="upload" class="panel" hidden>
      <h2 style="margin-top:0">อัปโหลดแอพหรือโปรแกรม (รองรับไฟล์ 1GB)</h2>

      <div class="panel" style="margin-bottom:12px">
        <strong>คำแนะนำ:</strong>
        <ul style="margin:8px 0 0 18px;">
          <li>จำเป็นต้องใส่ “ชื่อแอพ” และ “ประเภทแอพ/เกม”</li>
          <li>ไฟล์มือถือ (APK/AAB) ไม่จำเป็น — ถ้าไม่ใส่ ปุ่มดาวน์โหลดบนมือถือจะเป็นสีเทา</li>
          <li>มีระบบอัปโหลดเป็นชิ้น (chunk) รองรับไฟล์ถึง 1GB ต้องมีเซิร์ฟเวอร์รับชิ้นและรวมไฟล์</li>
        </ul>
      </div>

      <div class="grid-2">
        <div class="panel">
          <h3 style="margin-top:0">โปรไฟล์แอพ</h3>
          <div class="row">
            <div class="avatar" id="avatarPreview">โปรไฟล์</div>
            <div class="stack" style="flex:1">
              <div class="field">
                <label>รูปโปรไฟล์แอพ (PNG/JPG)</label>
                <input class="input" type="file" id="profileInput" accept="image/*" />
                <div class="hint">ไม่บังคับ</div>
              </div>
              <div class="grid-2">
                <div class="field">
                  <label>ชื่อแอพ (จำเป็น)</label>
                  <input class="input" type="text" id="nameInput" placeholder="เช่น: My Awesome App" />
                </div>
                <div class="field">
                  <label>ประเภทแอพ/เกม (จำเป็น)</label>
                  <select class="input" id="categoryInput">
                    <option value="">-- เลือกประเภท --</option>
                    <option>เกม</option>
                    <option>ยูทิลิตี้</option>
                    <option>การศึกษา</option>
                    <option>มัลติมีเดีย</option>
                    <option>เครื่องมือพัฒนา</option>
                    <option>อื่นๆ</option>
                  </select>
                </div>
              </div>
              <div class="field">
                <label>คำอธิบาย</label>
                <textarea id="descInput" placeholder="เล่าสั้นๆ ว่าทำอะไร จุดเด่นอะไร"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3 style="margin-top:0">ไฟล์แพลตฟอร์ม</h3>
          <div class="grid-2">
            <div class="stack">
              <h4 style="margin:0">เดสก์ท็อป (PC)</h4>
              <div class="field">
                <label>เวอร์ชั่น PC</label>
                <input class="input" type="text" id="desktopVerInput" placeholder="เช่น: 1.0.0" />
              </div>
              <div class="field">
                <label>ไฟล์เดสก์ท็อป</label>
                <input class="input" type="file" id="desktopFileInput" accept=".exe,.msi,.zip,.rar,.7z,.dmg,.pkg,.bin" />
                <div class="hint">รองรับไฟล์ใหญ่ถึง 1GB</div>
              </div>
              <div class="progress-wrap" id="desktopProgressWrap" hidden>
                <div class="mono" id="desktopProgressText">PC: 0%</div>
                <div class="progress-bar"><div id="desktopProgressBar"></div></div>
              </div>
            </div>
            <div class="stack">
              <h4 style="margin:0">มือถือ (Android APK)</h4>
              <div class="field">
                <label>เวอร์ชั่น APK</label>
                <input class="input" type="text" id="mobileVerInput" placeholder="เช่น: 1.0.0" />
              </div>
              <div class="field">
                <label>ไฟล์มือถือ (ไม่จำเป็น)</label>
                <input class="input" type="file" id="mobileFileInput" accept=".apk,.aab" />
                <div class="hint">รองรับไฟล์ใหญ่ถึง 1GB</div>
              </div>
              <div class="progress-wrap" id="mobileProgressWrap" hidden>
                <div class="mono" id="mobileProgressText">APK: 0%</div>
                <div class="progress-bar"><div id="mobileProgressBar"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <button type="button" class="btn" data-nav="list">ยกเลิก</button>
        <div class="spacer"></div>
        <button type="button" class="btn btn-primary" id="submitBtn">ตกลงอัปโหลด</button>
      </div>
      <p class="note">เมตาดาต้าจะถูกบันทึกใน localStorage ส่วนไฟล์จริงจะอยู่บนเซิร์ฟเวอร์ที่คุณกำหนด</p>
    </section>

    <section id="list" class="panel" hidden>
      <h2 style="margin-top:0">รายการดาวน์โหลด</h2>

      <div class="searchbar panel" style="padding:12px">
        <input class="input" type="text" id="searchInput" placeholder="ค้นหาแอพ..." />
        <select class="input" id="filterCategory">
          <option value="">ทุกประเภท</option>
          <option>เกม</option>
          <option>ยูทิลิตี้</option>
          <option>การศึกษา</option>
          <option>มัลติมีเดีย</option>
          <option>เครื่องมือพัฒนา</option>
          <option>อื่นๆ</option>
        </select>
        <button type="button" class="btn" id="clearFilter">ล้างการค้นหา</button>
      </div>

      <div class="list" id="appList"></div>

      <div class="panel" id="detailPanel" hidden>
        <div class="detail">
          <div class="cover" id="detailCover"></div>
          <div>
            <h3 id="detailTitle"></h3>
            <div class="meta" id="detailMeta"></div>
            <p id="detailDesc" style="margin-top:8px"></p>
            <div class="divider"></div>
            <div class="row">
              <button type="button" class="btn" id="downloadPcBtn">ดาวน์โหลดเวอร์ชั่น PC</button>
              <button type="button" class="btn" id="downloadApkBtn">ดาวน์โหลดเวอร์ชั่น APK</button>
              <span class="pill" id="deviceHint"></span>
              <div class="spacer"></div>
              <button type="button" class="btn btn-danger" id="deleteBtn">ลบแอพนี้ (เฉพาะข้อมูลของคุณ)</button>
            </div>
            <p class="note">ปุ่มจะเป็นสีเทาเมื่อไม่มีไฟล์สำหรับแพลตฟอร์มนั้นๆ</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    สร้างด้วย HTML/CSS/JS หน้าเดียว — ใช้การอัปโหลดแบบ chunk ไปยังเซิร์ฟเวอร์เพื่อรองรับไฟล์ใหญ่ถึง 1GB
  </footer>

  <script>
    // ---------- Utilities ----------
    const qs = (sel, el = document) => el.querySelector(sel);
    const qsa = (sel, el = document) => [...el.querySelectorAll(sel)];
    const $home = qs('#home'), $upload = qs('#upload'), $list = qs('#list');

    const isMobile = () => /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
    const device = isMobile() ? 'mobile' : 'desktop';
    qs('#deviceLabel').textContent = isMobile() ? 'มือถือ/แท็บเล็ต' : 'เดสก์ท็อป/แลปท็อป';

    const storageKey = 'community_apps_chunk_v1';
    const readStore = () => { try { return JSON.parse(localStorage.getItem(storageKey) || '[]'); } catch { return []; } };
    const writeStore = (apps) => { localStorage.setItem(storageKey, JSON.stringify(apps)); qs('#countLabel').textContent = String(apps.length); };
    writeStore(readStore());

    const navigate = (to) => {
      [$home, $upload, $list].forEach(s => s.hidden = true);
      if (to === 'upload') $upload.hidden = false;
      else if (to === 'list') $list.hidden = false;
      else $home.hidden = false;
      location.hash = to;
    };
    qsa('[data-nav]').forEach(btn => btn.addEventListener('click', () => navigate(btn.dataset.nav)));

    const extFromName = (name) => {
      if (!name) return null;
      const idx = name.lastIndexOf('.');
      return idx >= 0 ? name.substring(idx + 1).toLowerCase() : null;
    };

    // ---------- Upload form refs ----------
    const $profileInput = qs('#profileInput');
    const $avatarPreview = qs('#avatarPreview');
    const $nameInput = qs('#nameInput');
    const $categoryInput = qs('#categoryInput');
    const $descInput = qs('#descInput');
    const $desktopVerInput = qs('#desktopVerInput');
    const $desktopFileInput = qs('#desktopFileInput');
    const $mobileVerInput = qs('#mobileVerInput');
    const $mobileFileInput = qs('#mobileFileInput');
    const $submitBtn = qs('#submitBtn');

    // Preview profile image (small, not chunked)
    $profileInput.addEventListener('change', () => {
      const file = $profileInput.files?.[0];
      if (!file) { $avatarPreview.textContent = 'โปรไฟล์'; return; }
      const fr = new FileReader();
      fr.onload = () => $avatarPreview.innerHTML = `<img src="${fr.result}" alt="avatar" />`;
      fr.onerror = () => { $avatarPreview.textContent = 'โปรไฟล์'; alert('อ่านรูปโปรไฟล์ไม่สำเร็จ'); };
      fr.readAsDataURL(file);
    });

    // ---------- Chunk upload logic (front-end) ----------
    const MAX_FILE_SIZE = 1024 * 1024 * 1024; // 1GB
    const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB ต่อชิ้น (ปรับได้ตามเซิร์ฟเวอร์)
    const CONCURRENCY = 3; // จำนวนชิ้นที่อัปโหลดพร้อมกัน

    const apiBase = ''; // ตั้ง base URL ของ API เซิร์ฟเวอร์ เช่น 'https://your-server.com'
    const endpoints = {
      init: (kind) => `${apiBase}/upload/init?kind=${encodeURIComponent(kind)}`,
      chunk: (uploadId, index) => `${apiBase}/upload/chunk?id=${encodeURIComponent(uploadId)}&index=${index}`,
      complete: (uploadId) => `${apiBase}/upload/complete?id=${encodeURIComponent(uploadId)}`
    };

    const requestJSON = async (url, method = 'POST', bodyObj = {}) => {
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(bodyObj)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    };

    const uploadInit = async (file, kind, meta = {}) => {
      // meta: { filename, size, mime, version }
      const payload = {
        filename: file.name,
        size: file.size,
        mime: file.type || 'application/octet-stream',
        kind, // 'pc' or 'apk'
        version: meta.version || ''
      };
      const json = await requestJSON(endpoints.init(kind), 'POST', payload);
      // server should return { uploadId }
      if (!json.uploadId) throw new Error('init ไม่ได้ uploadId');
      return json.uploadId;
    };

    const uploadChunks = async (file, uploadId, onProgress, progressEls) => {
      const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
      let uploaded = 0;

      // producer of chunk indexes
      const indexes = Array.from({ length: totalChunks }, (_, i) => i);

      const sendChunk = async (index) => {
        const start = index * CHUNK_SIZE;
        const end = Math.min(start + CHUNK_SIZE, file.size);
        const blob = file.slice(start, end);

        const res = await fetch(endpoints.chunk(uploadId, index), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/octet-stream',
            'X-Chunk-Start': String(start),
            'X-Chunk-End': String(end),
            'X-Chunk-Size': String(end - start),
            'X-File-Size': String(file.size)
          },
          body: blob
        });
        if (!res.ok) throw new Error(`chunk ${index} ล้มเหลว (HTTP ${res.status})`);

        uploaded++;
        const percent = Math.floor((uploaded / totalChunks) * 100);
        if (onProgress) onProgress(percent);
        if (progressEls) {
          progressEls.text.textContent = `${file.name}: ${percent}%`;
          progressEls.bar.style.width = `${percent}%`;
        }
      };

      // run with limited concurrency
      const pool = [];
      for (let i = 0; i < CONCURRENCY; i++) {
        pool.push((async function worker() {
          while (indexes.length) {
            const idx = indexes.shift();
            await sendChunk(idx);
          }
        })());
      }
      await Promise.all(pool);
    };

    const uploadComplete = async (uploadId) => {
      const json = await requestJSON(endpoints.complete(uploadId), 'POST', {});
      // server should return { url } to download
      if (!json.url) throw new Error('complete ไม่ได้ URL');
      return json.url;
    };

    const validateInputs = () => {
      const name = $nameInput.value.trim();
      const category = $categoryInput.value.trim();
      if (!name) return 'กรุณาใส่ชื่อแอพ';
      if (!category) return 'กรุณาเลือกประเภทแอพ/เกม';

      const desktopFile = $desktopFileInput.files?.[0] || null;
      const mobileFile = $mobileFileInput.files?.[0] || null;

      if (desktopFile && desktopFile.size > MAX_FILE_SIZE) return 'ไฟล์เดสก์ท็อปใหญ่เกิน 1GB';
      if (mobileFile && mobileFile.size > MAX_FILE_SIZE) return 'ไฟล์มือถือใหญ่เกิน 1GB';

      const mobileExt = extFromName(mobileFile?.name || '');
      if (mobileFile && !(mobileExt === 'apk' || mobileExt === 'aab'))
        return 'ไฟล์มือถือต้องเป็น .apk หรือ .aab';
      return null;
    };

    const $desktopProgressWrap = qs('#desktopProgressWrap');
    const $desktopProgressText = qs('#desktopProgressText');
    const $desktopProgressBar = qs('#desktopProgressBar');

    const $mobileProgressWrap = qs('#mobileProgressWrap');
    const $mobileProgressText = qs('#mobileProgressText');
    const $mobileProgressBar = qs('#mobileProgressBar');

    let uploading = false;

    const safeDisable = (el, state) => {
      el.disabled = state;
      el.classList.toggle('disabled', state);
      el.textContent = state ? 'กำลังอัปโหลด...' : 'ตกลงอัปโหลด';
    };

    $submitBtn.addEventListener('click', async () => {
      if (uploading) return;
      const msg = validateInputs();
      if (msg) { alert(msg); return; }

      const name = $nameInput.value.trim();
      const category = $categoryInput.value.trim();
      const description = $descInput.value.trim();
      const desktopVersion = ($desktopVerInput.value || '').trim();
      const mobileVersion = ($mobileVerInput.value || '').trim();

      const profileFile = $profileInput.files?.[0] || null;
      let profileUrl = null;
      if (profileFile) {
        // small image: convert to dataURL for local preview
        const fr = new FileReader();
        profileUrl = await new Promise((resolve) => {
          fr.onload = () => resolve(fr.result);
          fr.onerror = () => resolve(null);
          fr.readAsDataURL(profileFile);
        });
      }

      const desktopFile = $desktopFileInput.files?.[0] || null;
      const mobileFile = $mobileFileInput.files?.[0] || null;

      try {
        uploading = true;
        safeDisable($submitBtn, true);

        let desktopUrl = null;
        let mobileUrl = null;

        // Upload PC file in chunks
        if (desktopFile) {
          $desktopProgressWrap.hidden = false;
          $desktopProgressText.textContent = 'กำลังเริ่มอัปโหลด PC...';
          $desktopProgressBar.style.width = '0%';

          const pcUploadId = await uploadInit(desktopFile, 'pc', {
            version: desktopVersion
          });
          await uploadChunks(desktopFile, pcUploadId, (p) => {
            // extra hook (optional)
          }, { text: $desktopProgressText, bar: $desktopProgressBar });
          desktopUrl = await uploadComplete(pcUploadId);
          $desktopProgressText.textContent = 'PC: เสร็จสิ้น 100%';
          $desktopProgressBar.style.width = '100%';
        }

        // Upload APK file in chunks (optional)
        if (mobileFile) {
          $mobileProgressWrap.hidden = false;
          $mobileProgressText.textContent = 'กำลังเริ่มอัปโหลด APK...';
          $mobileProgressBar.style.width = '0%';

          const apkUploadId = await uploadInit(mobileFile, 'apk', {
            version: mobileVersion
          });
          await uploadChunks(mobileFile, apkUploadId, (p) => {}, { text: $mobileProgressText, bar: $mobileProgressBar });
          mobileUrl = await uploadComplete(apkUploadId);
          $mobileProgressText.textContent = 'APK: เสร็จสิ้น 100%';
          $mobileProgressBar.style.width = '100%';
        }

        // Save metadata to localStorage
        const app = {
          id: 'app_' + Date.now(),
          name, category, description,
          profileUrl: profileUrl,
          desktop: {
            version: desktopVersion,
            fileName: desktopFile?.name || '',
            fileExt: extFromName(desktopFile?.name || ''),
            url: desktopUrl // URL จากเซิร์ฟเวอร์
          },
          mobile: {
            version: mobileVersion,
            fileName: mobileFile?.name || '',
            fileExt: extFromName(mobileFile?.name || ''),
            url: mobileUrl // URL จากเซิร์ฟเวอร์
          },
          createdAt: new Date().toISOString()
        };

        const apps = readStore();
        apps.unshift(app);
        writeStore(apps);

        // reset form
        [$nameInput, $descInput, $desktopVerInput, $mobileVerInput].forEach(i => i.value = '');
        $categoryInput.value = '';
        $profileInput.value = ''; $desktopFileInput.value = ''; $mobileFileInput.value = '';
        $avatarPreview.textContent = 'โปรไฟล์';
        $desktopProgressWrap.hidden = true; $mobileProgressWrap.hidden = true;

        alert('อัปโหลดสำเร็จ');
        renderList();
        navigate('list');
      } catch (err) {
        console.error(err);
        alert('อัปโหลดไม่สำเร็จ: ' + (err?.message || 'ไม่ทราบสาเหตุ'));
      } finally {
        uploading = false;
        safeDisable($submitBtn, false);
      }
    });

    // ---------- List rendering ----------
    const $appList = qs('#appList');
    const $searchInput = qs('#searchInput');
    const $filterCategory = qs('#filterCategory');
    const $clearFilter = qs('#clearFilter');

    let currentDetailId = null;

    const renderList = () => {
      const apps = readStore();
      qs('#countLabel').textContent = String(apps.length);

      const kw = ($searchInput.value || '').toLowerCase();
      const cat = ($filterCategory.value || '');
      const filtered = apps.filter(a => {
        const matchKw =
          !kw ||
          a.name.toLowerCase().includes(kw) ||
          (a.description || '').toLowerCase().includes(kw) ||
          a.category.toLowerCase().includes(kw);
        const matchCat = !cat || a.category === cat;
        return matchKw && matchCat;
      });

      if (!filtered.length) {
        $appList.innerHTML = `<div class="panel">ไม่พบบันทึกที่ตรงกับการค้นหา/ประเภท</div>`;
        qs('#detailPanel').hidden = true;
        return;
      }

      $appList.innerHTML = filtered.map(app => {
        const cover = app.profileUrl
          ? `<img src="${app.profileUrl}" alt="${app.name}"/>`
          : `<div style="display:grid;place-items:center;height:100%;color:#7f86a8">ไม่มีรูป</div>`;
        const pcVer = app.desktop.version ? `PC v${app.desktop.version}` : 'PC—ไม่มีเวอร์ชั่น';
        const apkVer = app.mobile.version ? `APK v${app.mobile.version}` : 'APK—ไม่มีเวอร์ชั่น';

        const pcAvailable = !!app.desktop.url;
        const apkAvailable = !!app.mobile.url;

        const pcBtn = `<button type="button" class="btn ${pcAvailable ? '' : 'disabled'}" data-dl="pc" data-id="${app.id}" ${pcAvailable ? '' : 'disabled'}>ดาวน์โหลดเวอร์ชั่น PC</button>`;
        const apkBtn = `<button type="button" class="btn ${apkAvailable ? '' : 'disabled'}" data-dl="apk" data-id="${app.id}" ${apkAvailable ? '' : 'disabled'}>ดาวน์โหลดเวอร์ชั่น APK</button>`;

        return `
          <div class="item" data-id="${app.id}">
            <div class="cover">${cover}</div>
            <div>
              <h3>${app.name}</h3>
              <div class="meta">
                <span class="badge">ประเภท: ${app.category}</span>
                <span class="badge">${pcVer}</span>
                <span class="badge">${apkVer}</span>
              </div>
              <p style="margin:8px 0 0; color:#cfd5ee; font-size:13px;">${app.description || '— ไม่มีคำอธิบาย —'}</p>
              <div class="row" style="margin-top:8px">
                ${device === 'desktop' ? `${pcBtn} ${apkBtn}` : `${apkBtn} ${pcBtn}`}
                <div class="spacer"></div>
                <button type="button" class="btn" data-view="${app.id}">ดูรายละเอียด</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      qsa('[data-view]').forEach(btn => btn.addEventListener('click', () => showDetail(btn.dataset.view)));
      qsa('[data-dl]').forEach(btn => btn.addEventListener('click', onDownloadClick));
    };

    const onDownloadClick = (e) => {
      const id = e.currentTarget.dataset.id;
      const kind = e.currentTarget.dataset.dl; // 'pc' or 'apk'
      const app = readStore().find(a => a.id === id);
      if (!app) return;

      let url = null, filename = '';
      if (kind === 'pc') {
        if (!app.desktop.url) return;
        url = app.desktop.url;
        filename = app.desktop.fileName || `${app.name}-PC.${app.desktop.fileExt || 'bin'}`;
      } else {
        if (!app.mobile.url) return;
        url = app.mobile.url;
        filename = app.mobile.fileName || `${app.name}-APK.${app.mobile.fileExt || 'apk'}`;
      }

      // เปิดดาวน์โหลดผ่านลิงก์ URL จากเซิร์ฟเวอร์
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    };

    // ---------- Detail panel ----------
    const $detailPanel = qs('#detailPanel');
    const $detailCover = qs('#detailCover');
    const $detailTitle = qs('#detailTitle');
    const $detailMeta = qs('#detailMeta');
    const $detailDesc = qs('#detailDesc');
    const $downloadPcBtn = qs('#downloadPcBtn');
    const $downloadApkBtn = qs('#downloadApkBtn');
    const $deviceHint = qs('#deviceHint');
    const $deleteBtn = qs('#deleteBtn');

    const showDetail = (id) => {
      const apps = readStore();
      const app = apps.find(a => a.id === id);
      if (!app) { $detailPanel.hidden = true; return; }
      currentDetailId = id;

      $detailCover.innerHTML = app.profileUrl
        ? `<img src="${app.profileUrl}" alt="${app.name}"/>`
        : `<div style="display:grid;place-items:center;height:100%;color:#7f86a8">ไม่มีรูป</div>`;

      $detailTitle.textContent = app.name;
      const metaParts = [
        `ประเภท: ${app.category}`,
        `PC: ${app.desktop.version || 'ไม่มี'}`,
        `APK: ${app.mobile.version || 'ไม่มี'}`
      ];
      $detailMeta.textContent = metaParts.join(' • ');
      $detailDesc.textContent = app.description || '— ไม่มีคำอธิบาย —';

      $deviceHint.textContent = device === 'desktop'
        ? 'คุณใช้งานบนเดสก์ท็อป'
        : 'คุณใช้งานบนมือถือ/แท็บเล็ต';

      setupDetailDownloadButtons(app);

      $detailPanel.hidden = false;
      $detailPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    const setupDetailDownloadButtons = (app) => {
      const pcAvail = !!app.desktop.url;
      const apkAvail = !!app.mobile.url;

      $downloadPcBtn.textContent = 'ดาวน์โหลดเวอร์ชั่น PC';
      $downloadApkBtn.textContent = 'ดาวน์โหลดเวอร์ชั่น APK';

      $downloadPcBtn.disabled = !pcAvail;
      $downloadApkBtn.disabled = !apkAvail;

      $downloadPcBtn.classList.toggle('disabled', !pcAvail);
      $downloadApkBtn.classList.toggle('disabled', !apkAvail);

      $downloadPcBtn.onclick = () => {
        if (!pcAvail) return;
        const a = document.createElement('a');
        a.href = app.desktop.url;
        a.download = app.desktop.fileName || `${app.name}-PC.${app.desktop.fileExt || 'bin'}`;
        document.body.appendChild(a); a.click(); a.remove();
      };
      $downloadApkBtn.onclick = () => {
        if (!apkAvail) return;
        const a = document.createElement('a');
        a.href = app.mobile.url;
        a.download = app.mobile.fileName || `${app.name}-APK.${app.mobile.fileExt || 'apk'}`;
        document.body.appendChild(a); a.click(); a.remove();
      };

      if (device === 'desktop') {
        $downloadPcBtn.classList.add('btn-success');
        $downloadApkBtn.classList.remove('btn-success');
      } else {
        $downloadApkBtn.classList.add('btn-success');
        $downloadPcBtn.classList.remove('btn-success');
      }
    };

    $deleteBtn.addEventListener('click', () => {
      if (!currentDetailId) return;
      const apps = readStore();
      const idx = apps.findIndex(a => a.id === currentDetailId);
      if (idx < 0) return;
      if (!confirm('ลบแอพนี้ออกจากรายการของเบราว์เซอร์คุณ?')) return;
      apps.splice(idx, 1);
      writeStore(apps);
      renderList();
      $detailPanel.hidden = true;
      alert('ลบสำเร็จ');
    });

    // ---------- Search/filter ----------
    $searchInput.addEventListener('input', renderList);
    $filterCategory.addEventListener('change', renderList);
    $clearFilter.addEventListener('click', () => {
      $searchInput.value = '';
      $filterCategory.value = '';
      renderList();
    });

    // ---------- Routing ----------
    const applyRoute = () => {
      const h = (location.hash || '#home').replace('#', '');
      navigate(h);
      renderList();
    };
    window.addEventListener('hashchange', applyRoute);
    applyRoute();
  </script>
</body>
</html>